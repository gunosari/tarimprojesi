// api/chat.js ‚Äî NL‚ÜíSQL (GPT + kural yedek), tek tablo: urunler (ƒ∞l, ƒ∞l√ße, √úr√ºn √áe≈üidi/Kategori, √úr√ºn, Yƒ±l, Alan, √úretim, Verim)
export const config = { runtime: 'nodejs' };

import fs from 'fs';
import path from 'path';
import initSqlJs from 'sql.js';
import OpenAI from 'openai';

// ============ Genel Ayarlar ============
const TABLE = 'urunler';
const MODEL = process.env.OPENAI_MODEL || 'gpt-4o-mini';

function qToText(rows, lineFmt) {
  if (!rows || rows.length === 0) return 'Veri bulunamadƒ±.';
  return rows.map(lineFmt).join('\n');
}

// ============ Dinamik ≈üema (PRAGMA) ============
function getColumns(SQL, db) {
  try {
    const cols = [];
    const stmt = db.prepare(`PRAGMA table_info("${TABLE}");`);
    while (stmt.step()) {
      const o = stmt.getAsObject();
      cols.push(o.name);
    }
    stmt.free();
    return cols;
  } catch {
    // Varsayƒ±lan ≈üema (sende bu var)
    return ['ƒ∞l', 'ƒ∞l√ße', '√úr√ºn √áe≈üidi', '√úr√ºn', 'Yƒ±l', 'Alan', '√úretim', 'Verim'];
  }
}

// G√ºvenlik filtresi (tek SELECT, yorum yok, sadece whitelist isimler)
function makeIsSafeSql(allowedNames) {
  const allow = new Set(allowedNames.map(s => s.toLowerCase()));
  return (sql) => {
    const s = (sql || '').trim().toLowerCase();
    if (!s.startsWith('select')) return false;
    if (s.includes('--') || s.includes('/*')) return false;
    const tokens = s.replace(/[^a-z0-9_ƒü√º≈ü√∂√ßƒ±ƒ∞ƒû√ú≈û√ñ√á" ]/gi, ' ').split(/\s+/).filter(Boolean);
    for (const t of tokens) {
      if (/^[a-zƒ±i√∂√º√ßƒü_"]+$/i.test(t) && !allow.has(t)) {
        if (!['select','sum','avg','count','min','max','from','where','and','or','group','by',
               'order','desc','asc','limit','as','having','like','between','in','distinct'].includes(t)) {
          return false;
        }
      }
    }
    return true;
  };
}

// ============ GPT Katmanƒ± ============
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

async function nlToSql_gpt(nl, cols, catColName) {
  if (!process.env.OPENAI_API_KEY) return '';

  const system = `
Sen bir NL‚ÜíSQLite SQL √ßevirmenisin.
Tek tablo: ${TABLE}("${cols.join('","')}")
- "√úretim": ton, "Alan": dekar, "Yƒ±l": tam sayƒ±.
- Kategori i√ßin kolon adƒ± "${catColName}".
- Yƒ±l belirtilmemi≈üse t√ºm yƒ±llarƒ± topla.
- Sadece TEK bir SELECT d√∂n ve sadece SQL yaz.
- Kolonlarƒ± double-quote ile yaz ("ƒ∞l","ƒ∞l√ße","${catColName}","√úr√ºn","Yƒ±l","Alan","√úretim","Verim").
  `.trim();

  const user = `
Soru: """${nl}"""
"ka√ß ton/toplam" -> SUM("√úretim"), "alan" -> SUM("Alan"), "verim" -> AVG("Verim") veya SUM("√úretim")/SUM("Alan").
Gerektiƒüinde GROUP BY / ORDER BY / LIMIT kullan.
Tablo adƒ±: ${TABLE}.
  `.trim();

  const r = await openai.responses.create({
    model: MODEL,
    input: [{ role: 'system', content: system }, { role: 'user', content: user }],
  });

  let text = (r.output_text || '').trim();
  let sql = text
    .replace(/```[\s\S]*?```/g, s => s.replace(/```(sql)?/g,'').replace(/```/g,'')) // ```sql``` bloklarƒ±nƒ± soy
    .trim()
    .replace(/;+\s*$/,''); // sondaki ; kaldƒ±r
  return sql;
}

// ============ Kural Tabanlƒ± Yedek ============
function ruleBasedSql(nlRaw, cols, catColName) {
  const nl = String(nlRaw || '').trim();

  // ƒ∞l
  const mIl = nl.match(/([A-Z√áƒûƒ∞√ñ≈û√ú][a-z√ßƒüƒ±√∂≈ü√º]+)(?:[‚Äô'`¬¥]?[dt]e|[‚Äô'`¬¥]?[dt]a|\s|$)/);
  const il = mIl ? mIl[1] : '';

  // Yƒ±l
  const year = (nl.match(/\b(19\d{2}|20\d{2})\b/) || [])[1] || '';

  // √úr√ºn anahtarlarƒ± (geni≈ü liste ‚Äì sebze/meyve/tahƒ±l karƒ±≈üƒ±k)
  const known = /(domates|biber|patlƒ±can|kabak|hƒ±yar|salatalƒ±k|karpuz|karnabahar|lahana|marul|fasulye|soƒüan|sarƒ±msak|patates|brokoli|ispanak|maydanoz|enginar|bezelye|bakla|elma|portakal|mandalina|limon|muz|zeytin|√ºz√ºm|armut|≈üeftali|kayƒ±sƒ±|nar|incir|vi≈üne|√ßilek|kiraz|kavun|ayva|fƒ±ndƒ±k|ceviz|antep fƒ±stƒ±ƒüƒ±|buƒüday|arpa|mƒ±sƒ±r|√ßeltik|pirin√ß|yulaf|√ßavdar|ay√ßi√ßeƒüi|kanola)/i;
  let urun = (nl.match(known) || [])[1] || '';
  if (!urun) {
    const mu = nl.match(/([a-z√ßƒüƒ±√∂≈ü√º]{3,})\s*(?:√ºr√ºn√º|√ºr√ºn)?\s*√ºretimi/i);
    if (mu) urun = mu[1];
  }
  urun = (urun || '').replace(/["'‚Äô`¬¥]+/g,'').trim();

  // Kategori (sende "√úr√ºn √áe≈üidi" kolonuna yansƒ±yor)
  let kat = '';
  if (/sebze/i.test(nl)) kat = 'Sebze';
  else if (/meyve/i.test(nl)) kat = 'Meyve';
  else if (/tah[ƒ±i]l/i.test(nl)) kat = 'Tahƒ±l';

  // 1) ‚Äú‚Ä¶ ka√ß ton sebze ‚Ä¶‚Äù veya ‚Äú‚Ä¶ toplam meyve √ºretimi ‚Ä¶‚Äù
  if (il && (/ka√ß\s+ton/i.test(nl) || /toplam.*√ºretim/i.test(nl)) && !urun) {
    return `
      SELECT SUM("√úretim") AS toplam_uretim
      FROM ${TABLE}
      WHERE "ƒ∞l"='${il}' ${kat ? `AND "${catColName}"='${kat}'` : ''} ${year ? `AND "Yƒ±l"=${year}` : ''}
    `.trim();
  }

  // 2) ‚Äúƒ∞l 20xx √ºr√ºn √ºretimi‚Äù / ‚Äúƒ∞l‚Äôde domates √ºretimi‚Äù
  if (il && urun && /√ºretim/i.test(nl)) {
    return `
      SELECT SUM("√úretim") AS toplam_uretim
      FROM ${TABLE}
      WHERE "ƒ∞l"='${il}' AND "√úr√ºn"='${urun}' ${year ? `AND "Yƒ±l"=${year}` : ''}
    `.trim();
  }

  // 3) ‚Äúƒ∞l‚Äôde toplam ekim alanƒ±‚Äù
  if (il && /(toplam)?.*(ekim )?alan/i.test(nl)) {
    return `
      SELECT SUM("Alan") AS toplam_alan
      FROM ${TABLE}
      WHERE "ƒ∞l"='${il}' ${kat ? `AND "${catColName}"='${kat}'` : ''} ${year ? `AND "Yƒ±l"=${year}` : ''}
    `.trim();
  }

  // 4) ‚Äúƒ∞l‚Äôde en √ßok √ºretilen 5 √ºr√ºn‚Äù
  const topN = (nl.match(/en √ßok √ºretilen\s+(\d+)/i) || [])[1] || 10;
  if (il && /(en √ßok √ºretilen\s+\d+\s+√ºr√ºn|en √ßok √ºretilen √ºr√ºn)/i.test(nl)) {
    return `
      SELECT "√úr√ºn" AS urun, SUM("√úretim") AS uretim, SUM("Alan") AS alan
      FROM ${TABLE}
      WHERE "ƒ∞l"='${il}' ${kat ? `AND "${catColName}"='${kat}'` : ''} ${year ? `AND "Yƒ±l"=${year}` : ''}
      GROUP BY "√úr√ºn"
      ORDER BY uretim DESC
      LIMIT ${topN}
    `.trim();
  }

  // 5) ‚Äúƒ∞l‚Äôde domates en √ßok hangi il√ßelerde ‚Ä¶‚Äù
  if (il && urun && /en √ßok hangi il√ßelerde/i.test(nl)) {
    return `
      SELECT "ƒ∞l√ße" AS ilce, SUM("√úretim") AS uretim, SUM("Alan") AS alan
      FROM ${TABLE}
      WHERE "ƒ∞l"='${il}' AND "√úr√ºn"='${urun}' ${year ? `AND "Yƒ±l"=${year}` : ''}
      GROUP BY "ƒ∞l√ße"
      ORDER BY uretim DESC
      LIMIT 10
    `.trim();
  }

  // 6) ‚Äúƒ∞l‚Äôde ortalama verim‚Äù (Alan/√úretim‚Äôden)
  if (il && /verim/i.test(nl)) {
    return `
      SELECT CASE WHEN SUM("Alan")>0 THEN ROUND(SUM("√úretim")/SUM("Alan"), 4) ELSE NULL END AS ort_verim
      FROM ${TABLE}
      WHERE "ƒ∞l"='${il}' ${kat ? `AND "${catColName}"='${kat}'` : ''} ${year ? `AND "Yƒ±l"=${year}` : ''}
    `.trim();
  }

  return '';
}

// ============ G√ºzel cevap (opsiyonel GPT) ============
async function prettyAnswer(question, rows) {
  if (!process.env.OPENAI_API_KEY) {
    if (!rows?.length) return 'Veri bulunamadƒ±.';
    if (rows.length === 1) return Object.entries(rows[0]).map(([k,v]) => `${k}: ${v}`).join(' ‚Ä¢ ');
    return `${rows.length} satƒ±r d√∂nd√º.`;
  }
  const sample = Array.isArray(rows) ? rows.slice(0, 5) : [];
  const r = await openai.responses.create({
    model: MODEL,
    input: [
      { role: 'system', content: 'Kƒ±sa ve net T√ºrk√ße cevap ver. Sayƒ±larƒ± binlik ayƒ±rƒ±cƒ±yla yaz.' },
      { role: 'user', content: `Soru: ${question}\n√ñrnek veri: ${JSON.stringify(sample)}\nToplam satƒ±r: ${rows.length}\n1-2 c√ºmle √∂zet yaz.` }
    ],
  });
  return (r.output_text || '').trim();
}

// ============ Handler ============
export default async function handler(req, res) {
  try {
    if (req.method !== 'POST') {
      res.status(405).json({ ok: false, error: 'Sadece POST isteklerine izin verilir' }); return;
    }

    const { question } = req.body || {};
    const raw = String(question ?? '').trim();
    if (!raw) { res.status(400).json({ ok: false, error: 'question alanƒ± zorunlu' }); return; }

    const SQL = await initSqlJs({
      locateFile: (file) => path.join(process.cwd(), 'node_modules/sql.js/dist', file),
    });

    const dbPath = path.join(process.cwd(), 'public', 'tarimdb.sqlite');
    if (!fs.existsSync(dbPath)) { res.status(500).json({ ok: false, error: 'tarimdb.sqlite bulunamadƒ±' }); return; }
    const db = new SQL.Database(fs.readFileSync(dbPath));

    // Dinamik kolon seti + g√ºvenlik filtresi
    const COLS = getColumns(SQL, db);
    const hasKategori = COLS.includes('Kategori');
    const hasUrunCesidi = COLS.includes('√úr√ºn √áe≈üidi');
    const catColName = hasKategori ? 'Kategori' : (hasUrunCesidi ? '√úr√ºn √áe≈üidi' : 'Kategori'); // prompt i√ßin isim
    const isSafeSql = makeIsSafeSql([TABLE, ...COLS.map(c => `"${c}"`)]);

    // Hƒ±zlƒ± kƒ±sa yol: "ƒ∞l, √úr√ºn" -> il√ße kƒ±rƒ±lƒ±mƒ± top 10
    if (raw.includes(',')) {
      const [ilInput, urunInput] = raw.split(',').map(s => s.trim());
      const stmt = db.prepare(`
        SELECT "ƒ∞l√ße" AS ilce, SUM("√úretim") AS uretim, SUM("Alan") AS alan
        FROM ${TABLE}
        WHERE "ƒ∞l"=? AND "√úr√ºn"=?
        GROUP BY "ƒ∞l√ße"
        ORDER BY uretim DESC
        LIMIT 10;
      `);
      const rows = [];
      stmt.bind([ilInput, urunInput]);
      while (stmt.step()) rows.push(stmt.getAsObject());
      stmt.free();
      const text = qToText(rows, r => `‚Ä¢ ${r.ilce}: ${r.uretim} ton, ${r.alan} dekar`);
      res.setHeader('Content-Type', 'text/plain; charset=utf-8');
      res.status(200).send(`üß≠ Mod: il_urun_ilce_top\nƒ∞l: ${ilInput} | √úr√ºn: ${urunInput}\n\n${text}`);
      return;
    }

    // 1) GPT ile deneriz
    let used = 'nl2sql-gpt', gptErr = '', sql = '';
    try {
      sql = await nlToSql_gpt(raw, COLS, catColName);
    } catch (e) {
      gptErr = `${e?.status || e?.code || ''} ${e?.message || String(e)}`;
      used = 'fallback-rules';
    }

    // 2) Uygunsuz/bo≈üsa kural tabanlƒ±
    if (!sql || !isSafeSql(sql)) {
      const rb = ruleBasedSql(raw, COLS, catColName);
      if (rb && isSafeSql(rb)) { sql = rb; used = 'rules'; }
    }

    // 3) H√¢l√¢ SQL yoksa: il adƒ±na g√∂re top √ºr√ºnler (debug dostu)
    if (!sql) {
      const ilInput = raw;
      const stmt = db.prepare(`
        SELECT "√úr√ºn" AS urun, SUM("√úretim") AS uretim, SUM("Alan") AS alan
        FROM ${TABLE}
        WHERE "ƒ∞l"=?
        GROUP BY "√úr√ºn"
        ORDER BY uretim DESC
        LIMIT 10;
      `);
      const rows = [];
      stmt.bind([ilInput]);
      while (stmt.step()) rows.push(stmt.getAsObject());
      stmt.free();
      const text = qToText(rows, r => `‚Ä¢ ${r.urun?.trim?.()}: ${r.uretim} ton, ${r.alan} dekar`);
      res.setHeader('Content-Type', 'text/plain; charset=utf-8');
      res.status(200).send(`üß≠ Mod: fallback_il_top_urun\nƒ∞l: ${ilInput}\n\n${text}`);
      return;
    }

    // 4) SQL'i √ßalƒ±≈ütƒ±r
    let rows = [];
    try {
      const stmt = db.prepare(sql);
      while (stmt.step()) rows.push(stmt.getAsObject());
      stmt.free();
    } catch (e) {
      res.setHeader('Content-Type', 'text/plain; charset=utf-8');
      res.status(200).send(`üß≠ Mod: ${used} (model: ${MODEL})\nSQL derlenemedi.\nSQL:\n${sql}\n\nHata: ${String(e)}`);
      return;
    }

    // 5) √ñzet
    const nice = await prettyAnswer(raw, rows);
    res.setHeader('Content-Type', 'text/plain; charset=utf-8');
    res.status(200).send(
      `üß≠ Mod: ${used} (model: ${MODEL})${gptErr ? ` | gptErr: ${gptErr}` : ''}\n` +
      `Soru: ${raw}\nSQL: ${sql}\n\n${nice}\n\n` +
      (rows.length ? qToText(rows, r => '‚Ä¢ ' + JSON.stringify(r)) : 'Veri bulunamadƒ±.')
    );

  } catch (err) {
    console.error('API hata:', err);
    res.status(500).json({ ok: false, error: 'FUNCTION_INVOCATION_FAILED', detail: String(err) });
  }
}
