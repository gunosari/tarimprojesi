<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TarÄ±m Verileri AsistanÄ±</title>
    <style>
      body { 
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
        max-width: 820px; 
        margin: 32px auto; 
        padding: 0 16px; 
        line-height: 1.5; 
        background: #fafafa;
      }
      .container {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      h1 { 
        margin-bottom: 8px; 
        color: #1f2937;
        font-size: 24px;
      }
      .row { 
        display: flex; 
        gap: 8px; 
        margin: 16px 0;
      }
      input[type="text"] { 
        flex: 1; 
        padding: 12px 16px; 
        font-size: 16px; 
        border: 2px solid #e5e7eb; 
        border-radius: 8px; 
        transition: border-color 0.2s;
      }
      input[type="text"]:focus {
        outline: none;
        border-color: #0B3D91;
      }
      button { 
        padding: 12px 20px; 
        font-size: 15px; 
        border: 0; 
        border-radius: 8px; 
        background: #0B3D91; 
        color: white; 
        cursor: pointer; 
        font-weight: 500;
        transition: background 0.2s;
      }
      button:hover:not([disabled]) {
        background: #0a2d6b;
      }
      button[disabled] { 
        opacity: .6; 
        cursor: not-allowed; 
      }
      .samples { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 8px; 
        margin: 16px 0 20px; 
      }
      .chip { 
        border: 1px solid #d1d5db; 
        border-radius: 999px; 
        padding: 8px 12px; 
        cursor: pointer; 
        font-size: 14px; 
        background: #f9fafb; 
        transition: all 0.2s;
        color: #374151;
      }
      .chip:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
      }
      .muted { 
        color: #6b7280; 
        font-size: 14px; 
        margin-bottom: 20px;
      }
      .response-area {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
      }
      .answer-box { 
        background: #f0fdf4; 
        border: 1px solid #bbf7d0;
        border-left: 4px solid #10b981;
        border-radius: 8px; 
        padding: 16px; 
        min-height: 60px;
        font-size: 16px;
        color: #065f46;
        line-height: 1.6;
      }
      .error-box {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-left: 4px solid #ef4444;
        border-radius: 8px;
        padding: 16px;
        color: #dc2626;
      }
      .loading {
        color: #6b7280;
        font-style: italic;
        padding: 16px;
        text-align: center;
      }
      .meta-info {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 8px;
        text-align: right;
      }
      @media (max-width: 640px) {
        .container {
          margin: 16px;
          padding: 20px 16px;
        }
        .row {
          flex-direction: column;
        }
        input[type="text"] {
          margin-bottom: 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸŒ¾ TarÄ±m Verileri AsistanÄ±</h1>
      <p class="muted">TÃ¼rkiye tarÄ±m Ã¼retim verilerini doÄŸal dille sorgulayÄ±n. Ã–rnek: "Mersin'de kaÃ§ ton sebze Ã¼retilmiÅŸ?"</p>
      
      <div class="row">
        <input id="q" type="text" placeholder='Ã–rnek: "Antalya'da domates Ã¼retimi ne kadar?"' maxlength="200" />
        <button id="send">Sorgula</button>
      </div>
      
      <div class="samples">
        <span class="chip">Mersin'de kaÃ§ ton sebze Ã¼retilmiÅŸ?</span>
        <span class="chip">Adana'da en Ã§ok Ã¼retilen 5 Ã¼rÃ¼n</span>
        <span class="chip">Antalya'da domates en Ã§ok hangi ilÃ§elerde Ã¼retiliyor?</span>
        <span class="chip">Ä°zmir'de toplam ekim alanÄ±</span>
        <span class="chip">2023 yÄ±lÄ±nda elma Ã¼retimi</span>
      </div>

      <div id="responseArea" class="response-area" style="display: none;">
        <div id="output" class="answer-box"></div>
        <div id="metaInfo" class="meta-info"></div>
      </div>
    </div>

    <script>
      const $ = (s) => document.querySelector(s);
      const q = $('#q');
      const btn = $('#send');
      const output = $('#output');
      const responseArea = $('#responseArea');
      const metaInfo = $('#metaInfo');

      // Ã–rnek chip'lere tÄ±klayÄ±nca inputa yaz
      document.querySelectorAll('.chip').forEach(chip => {
        chip.addEventListener('click', () => {
          q.value = chip.textContent;
          q.focus();
        });
      });

      // Enter ile gÃ¶nder
      q.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !btn.disabled) {
          send();
        }
      });

      btn.addEventListener('click', send);
      q.focus(); // Otofocus

      async function send() {
        const question = q.value.trim();
        if (!question) {
          showError('LÃ¼tfen bir soru girin.');
          q.focus();
          return;
        }

        // UI gÃ¼ncellemeleri
        btn.disabled = true;
        const oldLabel = btn.textContent;
        btn.textContent = 'SorgulanÄ±yor...';
        
        responseArea.style.display = 'block';
        output.className = 'loading';
        output.textContent = 'Veriler sorgulanÄ±yor, lÃ¼tfen bekleyin...';
        metaInfo.textContent = '';

        const startTime = Date.now();

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
          });

          const data = await response.json();
          const processingTime = Date.now() - startTime;

          if (!response.ok) {
            throw new Error(data.detail || data.error || 'Bir hata oluÅŸtu');
          }

          // BaÅŸarÄ±lÄ± yanÄ±t
          showAnswer(data.answer, data.processingTime || processingTime, data.cached);

        } catch (error) {
          console.error('Hata:', error);
          
          if (error.message.includes('429') || error.message.includes('fazla istek')) {
            showError('Ã‡ok fazla istek gÃ¶nderildi. LÃ¼tfen bir dakika bekleyip tekrar deneyin.');
          } else if (error.message.includes('network') || error.message.includes('Failed to fetch')) {
            showError('BaÄŸlantÄ± hatasÄ±. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
          } else {
            showError(error.message || 'Beklenmeyen bir hata oluÅŸtu.');
          }
        } finally {
          btn.disabled = false;
          btn.textContent = oldLabel;
        }
      }

      function showAnswer(answer, processingTime, cached) {
        output.className = 'answer-box';
        output.textContent = answer;
        
        let timeText = `Ä°ÅŸlem sÃ¼resi: ${processingTime}ms`;
        if (cached) timeText += ' (Ã¶nbellekten)';
        metaInfo.textContent = timeText;
        
        // Cevaba scroll
        output.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      function showError(message) {
        output.className = 'error-box';
        output.textContent = message;
        metaInfo.textContent = '';
      }
    </script>
  </body>
</html>
