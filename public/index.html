<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tarım Chatbot</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 820px; margin: 32px auto; padding: 0 16px; line-height: 1.5; }
      h1 { margin-bottom: 8px; }
      .row { display: flex; gap: 8px; margin: 12px 0 8px; }
      input[type="text"] { flex: 1; padding: 10px 12px; font-size: 16px; border: 1px solid #ccc; border-radius: 8px; }
      button { padding: 10px 14px; font-size: 15px; border: 0; border-radius: 8px; background: #0B3D91; color: white; cursor: pointer; }
      button[disabled] { opacity: .6; cursor: not-allowed; }
      .samples { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0 16px; }
      .chip { border: 1px solid #ddd; border-radius: 999px; padding: 6px 10px; cursor: pointer; font-size: 14px; background: #f7f7f7; }
      .muted { color: #666; font-size: 14px; }
      pre { white-space: pre-wrap; word-break: break-word; background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 12px; min-height: 120px; }
    </style>
  </head>
  <body>
    <h1>Tarım Chatbot Çalışıyor</h1>
    <p class="muted">Aşağıya doğal dille yaz, ben SQL’e çevirip veritabanından getirip cevaplayayım.</p>

    <div class="row">
      <input id="q" type="text" placeholder='ör. "Mersin’de kaç ton sebze üretilmiş?"' />
      <button id="send">Gönder</button>
    </div>

    <div class="samples">
      <span class="chip">Mersin’de kaç ton sebze üretilmiş?</span>
      <span class="chip">Adana’da en çok üretilen 5 ürün</span>
      <span class="chip">Antalya’da domates en çok hangi ilçelerde üretiliyor?</span>
      <span class="chip">İzmir’de toplam ekim alanı (dekar)</span>
      <span class="chip">Mersin 2022 biber üretimi</span>
    </div>

    <pre id="out"></pre>

    <script>
      const $ = (s) => document.querySelector(s);
      const q = $('#q');
      const btn = $('#send');
      const out = $('#out');

      // Örnek chip'lere tıklayınca inputa yaz
      document.querySelectorAll('.chip').forEach(chip => {
        chip.addEventListener('click', () => {
          q.value = chip.textContent;
          q.focus();
        });
      });

      // Enter ile gönder
      q.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') send();
      });

      btn.addEventListener('click', send);

      async function send() {
        const question = q.value.trim();
        if (!question) {
          out.textContent = 'Bir soru yazmalısın.';
          q.focus();
          return;
        }

        btn.disabled = true;
        const oldLabel = btn.textContent;
        btn.textContent = 'Yükleniyor…';
        out.textContent = '';

        try {
          const r = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ question })
          });

          // Text veya JSON gelebilir; varsayılanı text kabul ediyoruz
          const ct = r.headers.get('content-type') || '';
          const payload = ct.includes('application/json') ? JSON.stringify(await r.json(), null, 2)
                                                          : await r.text();
          out.textContent = payload;
        } catch (err) {
          out.textContent = 'İstek başarısız oldu: ' + (err?.message || String(err));
        } finally {
          btn.disabled = false;
          btn.textContent = oldLabel;
        }
      }
    </script>
  </body>
</html>
